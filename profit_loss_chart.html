<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit/Loss Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
   display: flex;
   flex-direction: column;
   align-items: center;
}

canvas {
   max-width: 800px;
   max-height: 400px;
}

.top-right {
   position: absolute;
   top: 20px;
   right: 20px;
}
</style>

</head>

<body>

<div style="height:50vh;width:80%;margin:auto;">
   <!-- Canvas element for Chart.js line chart-->
   <canvas id="combinedChart"></canvas> <!-- Single canvas for combined chart -->

   <!-- Chart.js script to create line chart-->
   <script>
const labels = {{ dates | tojson }};
const dailyTotalsDataValues = {{ daily_totals | tojson }};
const changesInTotalsDataValues = {{ changes_in_totals | tojson }};

// Prepare data for the combined chart
const combinedData = {
   labels,
   datasets: [
       {
           label: 'Daily Total Profit/Loss',
           backgroundColor: 'rgba(75,192,192,0.2)',
           borderColor: 'rgba(75,192,192,1)',
           data: dailyTotalsDataValues,
           fill: true,
           tension: .1,
       },
       {
           label: 'Change in Total Profit/Loss',
           data: [null].concat(changesInTotalsDataValues), // Add null for the first point
           fill: false,
           borderWidth: 2,
           tension: 0.1,
           segment: {
               borderColor: (ctx) => {
                   const currentValue = ctx.chart.data.datasets[1].data[ctx.p0DataIndex];
                   const previousValue = ctx.chart.data.datasets[1].data[ctx.p0DataIndex - 1];

                   // Determine color based on transition
                   if (previousValue === undefined) {
                       return 'rgba(75, 192, 75, 1)'; // Default to green if there's no previous value
                   } else if (previousValue < 0 && currentValue >= 0) {
                       return 'rgba(75, 192, 75, 1)'; // Green when changing from negative to positive
                   } else if (previousValue > 0 && currentValue < 0) {
                       return 'rgba(255, 99, 132, 1)'; // Red when changing from positive to negative
                   } else if (currentValue >= 0) {
                       return 'rgba(75, 192, 75, 1)'; // Green for positive values
                   } else {
                       return 'rgba(255, 99, 132, 1)'; // Red for negative values
                   }
               },
               borderDash: [0, 0], // Solid lines
           }
       }
   ]
};

const config = {
   type: 'line',
   data: combinedData,
   options: {
       responsive: true,
       plugins: {
           tooltip: {
               mode: 'index', // Show tooltips for all datasets at the hovered index
               intersect: false // Allow tooltips to show even if not directly on a point
           }
       },
       interaction: {
           mode: 'index', // Enable index mode for hover interaction
           intersect: false // Allow hover over any dataset
       },
       scales: {
           y: {
               beginAtZero: true,
               title: {
                   display: true,
                   text: 'Amount'
               }
           },
           x: {
               title: {
                   display: true,
                   text: 'Date'
               }
           }
       }
   }
};

const combinedChart = new Chart(
   document.getElementById('combinedChart'),
   config
);
</script>

<h2><a href="{{ url_for('index') }}">Back to Home</a></h2>

</body>
</html>
