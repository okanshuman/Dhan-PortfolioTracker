<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit/Loss Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html, body {
            height: 100%; /* Full height */
            margin: 0; /* Remove default margin */
        }

        canvas {
            width: 100% !important; /* Full width */
            height: 100% !important; /* Full height */
        }
    </style>
</head>

<body>

<div style="height:100%; width:100%;">
   <!-- Canvas element for Chart.js line chart-->
   <canvas id="combinedChart"></canvas> <!-- Single canvas for combined chart -->

   <!-- Chart.js script to create line chart-->
   <script>
       const labels = {{ dates | tojson }}; // Ensure this is an array of date strings
       const dailyTotalsDataValues = {{ daily_totals | tojson }};
       const changesInTotalsDataValues = [0].concat({{ changes_in_totals | tojson }}); // Prepend a zero for alignment

       // Prepare data for the combined chart
       const combinedData = {
           labels,
           datasets: [
               {
                   label: 'Daily Total Profit/Loss',
                   backgroundColor: 'rgba(75,192,192,0.2)',
                   data: dailyTotalsDataValues,
                   fill: true,
                   tension: .1,
                   segment: {
                       borderColor: (ctx) => {
                           const index = ctx.p0DataIndex;
                           if (index === 0) return 'rgba(75,192,192,1)'; // Default color for first point

                           const previousChange = changesInTotalsDataValues[index - 1];
                           const currentChange = changesInTotalsDataValues[index];

                           // Determine color based on previous and current change amounts
                           if (previousChange < 0 && currentChange >= 0) {
                               return 'rgba(75,192,75,1)'; // Green when changing from negative to positive
                           } else if (previousChange > 0 && currentChange < 0) {
                               return 'rgba(255,99,132,1)'; // Red when changing from positive to negative
                           } else if (currentChange >= 0) {
                               return 'rgba(75,192,75,1)'; // Green for positive values
                           } else {
                               return 'rgba(255,99,132,1)'; // Red for negative values
                           }
                       }
                   }
               }
           ]
       };

       const config = {
           type: 'line',
           data: combinedData,
           options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                   tooltip: {
                       callbacks: {
                           label: function(tooltipItem) {
                               const dailyTotal = tooltipItem.raw;
                               const changeAmount = changesInTotalsDataValues[tooltipItem.dataIndex];
                               return `Daily Total: ${dailyTotal} (Change: ${changeAmount})`;
                           }
                       },
                       mode: 'index', // Show tooltips for all datasets at the hovered index
                       intersect: false // Allow tooltips to show even if not directly on a point
                   }
               },
               interaction: {
                   mode: 'index', // Enable index mode for hover interaction
                   intersect: false // Allow hover over any dataset
               },
               scales: {
                   y: {
                       beginAtZero: true,
                       title: {
                           display: true,
                           text: 'Amount'
                       }
                   },
                   x: {
                       type: 'category', // Use category type for x-axis since we have date strings
                       title: {
                           display: true,
                           text: 'Date'
                       }
                   }
               }
           }
       };

       const combinedChart = new Chart(
           document.getElementById('combinedChart'),
           config
       );
   </script>

</div>

</body>
</html>
